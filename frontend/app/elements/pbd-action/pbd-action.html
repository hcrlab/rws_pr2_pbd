<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/ros-ros/ros-ros.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="pbd-action">
  <template>
    <style include="shared-styles"></style>
    <style include="iron-flex"></style>
    <style>
      :host {
        display: block;
      }
      #backButton:hover {
        background-color: var(--paper-grey-300);
      }
      #nameInput {
        max-width: 500px;
        position: relative;
        top: -11px;
      }
      #executeButton {
        color: rgba(255, 255, 255, 1);
        background-color: var(--paper-green-500);
        margin-left: 10px;
        margin-bottom: 13px;
      }
    </style>
    <ros-ros ros="{{ros}}" on-connection="_onRosConnected"></ros-ros>
    <ros-service
      id="findService"
      on-fail="_onFindError"
      on-response="_onResponse"
      name="/mongo_msg_db/find"
      ros="{{ros}}"
      service-type="mongo_msg_db_msgs/Find"
    ></ros-service>
    <ros-service
      id="updateService"
      on-fail="_onUpdateError"
      name="/mongo_msg_db/update"
      ros="{{ros}}"
      service-type="mongo_msg_db_msgs/Update"
    ></ros-service>
    <ros-service
      id="executeService"
      on-fail="_onExecuteError"
      name="/execute_action"
      ros="{{ros}}"
      service-type="pr2_pbd_interaction/ExecuteActionById"
    ></ros-service>
    <paper-button id="backButton" on-tap="_goToList">
      <iron-icon icon="arrow-back"></iron-icon>
      <span>Back to program list</span>
    </paper-button>
    <div id="header" class="center layout horizontal">
      <paper-input
        class="flex"
        id="nameInput"
        label="Action name"
        value="{{action.name}}"
        on-change="_onNameChange"
      ></paper-input>
      <paper-button raised id="executeButton" on-tap="_onExecute">
        <iron-icon icon="av:play-arrow"></iron-icon>
        <span>Execute</span>
      </paper-button>
    </div>
    <div id="viz">
    </div>
    <paper-toast id="toast" duration="0">
      <paper-button on-tap="_closeToast">Dismiss</paper-button>
    </paper-toast>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'pbd-action',

      properties: {
        action: Object,
        id: {
          type: String,
          notify: true
        },
        isRosConnected: {
          type: Boolean,
          value: false,
        },
        routeData: {
          type: Object,
          notify: true,
        },
        ros: Object,
      },

      observers: [
        '_onFindPrereqs(isRosConnected, id)',
      ],

      _closeToast: function() {
        this.$.toast.close();
      },

      _goToList: function() {
        this.set('routeData.id', '');
      },

      _onExecute: function() {
        var msg = {
          action_id: this.id,
        };
        this.$.executeService.call(msg);
      },

      _onExecuteError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to execute action.';
        this.$.toast.show();
      },

      _onFindError: function(evt) {
        console.error('Error looking up ID: ' + this.id, evt.detail);
        this.$.toast.text = 'Failed to load action.';
        this.$.toast.show();
      },

      _onFindPrereqs: function(isRosConnected, id) {
        if (isRosConnected && id) {
          var msg = {
            collection: {
              db: 'pr2_pbd',
              collection: 'actions',
            },
            id: id,
          };
          this.$.findService.call(msg);
        }
      },

      _onNameChange: function() {
        this.action.name = this.$.nameInput.value;
        var msg = {
          collection: {
            db: 'pr2_pbd',
            collection: 'actions',
          },
          message: {
            id: this.id,
            json: JSON.stringify(this.action),
            msg_type: 'pr2_pbd_interaction/Action',
          }
        };
        this.$.updateService.call(msg);
      },

      _onResponse: function(evt) {
        if (evt.detail.matched_count !== 1) {
          this._onFindError();
        }
        this.action = JSON.parse(evt.detail.message.json);
      },

      _onRosConnected: function() {
        this.isRosConnected = true;
      },

      _onUpdateError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to save action to the database.';
        this.$.toast.show();
      },
    });
  })();
  </script>
</dom-module>
