<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../pbd-step/pbd-step.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="pbd-action">
  <template>
    <style include="shared-styles"></style>
    <style include="iron-flex"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      #backButton:hover {
        background-color: var(--paper-grey-300);
      }
      #container {
        height: 100%;
      }
      #nameInput {
        max-width: 500px;
        position: relative;
        top: -11px;
      }
      #executeButton {
        color: rgba(255, 255, 255, 1);
        background-color: var(--paper-green-500);
        margin-left: 10px;
        margin-bottom: 13px;
      }
      #viz {
        position: relative;
      }
      #rviz {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #steps {
        margin-bottom: 8px;
        overflow: auto;
      }
      pbd-step.iron-selected {
        font-weight: bold;
      }
    </style>
    <ros-service
      id="findService"
      on-fail="_onFindError"
      on-response="_onResponse"
      name="/mongo_msg_db/find"
      ros="{{ros}}"
      service-type="mongo_msg_db_msgs/Find"
    ></ros-service>
    <ros-service
      id="updateService"
      on-fail="_onUpdateError"
      name="/mongo_msg_db/update"
      ros="{{ros}}"
      service-type="mongo_msg_db_msgs/Update"
    ></ros-service>
    <ros-service
      id="executeService"
      on-fail="_onExecuteError"
      name="/execute_action"
      ros="{{ros}}"
      service-type="pr2_pbd_interaction/ExecuteActionById"
    ></ros-service>
    <ros-service
      id="startStateService"
      on-fail="_onStartStateError"
      name="/subscribe_pbd_state"
      ros="{{ros}}"
      service-type="rws_pr2_pbd/PublishRobotState"
    ></ros-service>
    <!--ros-service
      id="stopStateService"
      on-fail="_onStopStateError"
      name="/unsubscribe_pbd_state"
      ros="{{ros}}"
      service-type="rws_pr2_pbd/StopRobotState"
    ></ros-service-->
    <div id="container" class="layout vertical">
      <div>
      <paper-button id="backButton" on-tap="_goToList">
        <iron-icon icon="arrow-back"></iron-icon>
        <span>Back to program list</span>
      </paper-button>
      </div>
      <div id="header" class="center layout horizontal">
        <paper-input
          class="flex"
          id="nameInput"
          label="Action name"
          value="{{action.name}}"
          on-change="_onNameChange"
        ></paper-input>
        <paper-button raised id="executeButton" on-tap="_onExecute">
          <iron-icon icon="av:play-arrow"></iron-icon>
          <span>Execute</span>
        </paper-button>
      </div>
      <div class="center layout horizontal">
        <label>Steps:</label>
        <iron-selector id="steps" selected="{{selectedStep}}" class="center layout horizontal">
          <template is="dom-repeat" items="{{action.sequence.seq}}">
            <pbd-step index="{{index}}"></pbd-step>
          </template>
        </iron-selector>
      </div>
      <div id="viz" class="flex">
        <ros-rviz id="rviz" global-options="{{globalOptions}}" ros="{{ros}}"></ros-rviz>
      </div>
    </div>
    <paper-toast id="toast" duration="0">
      <paper-button on-tap="_closeToast">Dismiss</paper-button>
    </paper-toast>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'pbd-action',

      properties: {
        action: Object,
        actionId: {
          type: String,
          notify: true
        },
        clientId: String,
        globalOptions: Object,
        routeData: {
          type: Object,
          notify: true,
        },
        ros: Object,
        selectedStep: {
          type: Number,
          value: 0,
        },
      },

      observers: [
        '_updateState(clientId, actionId, selectedStep)',
        '_onFindPrereqs(ros, actionId)',
        '_clientIdChanged(globalOptions.clientId)',
      ],

      ready: function() {
        // TODO(jstn): MoveIt freaks out when you remove frames, printing out
        // gigabytes of warnings about the frames being missing. Need to fix
        // this somehow. For now, we never unsubscribe and assume the programs
        // are short-lived.
        //var that = this;
        //window.addEventListener('unload', function() {
        //  that.$.stopStateService.call({
        //    client_id: that.clientId,
        //  });
        //});
      },

      onRosConnected: function() {
      },

      reset: function() {
        this.selectedStep = 0;
      },


      _clientIdChanged: function(clientId) {
        this.clientId = clientId;
      },

      _closeToast: function() {
        this.$.toast.close();
      },

      _goToList: function() {
        this.set('routeData.id', '');
      },

      _onExecute: function() {
        var msg = {
          action_id: this.actionId,
        };
        this.$.executeService.call(msg);
      },

      _onExecuteError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to execute action.';
        this.$.toast.show();
      },

      _onFindError: function(evt) {
        console.error('Error looking up ID: ' + this.actionId, evt.detail);
        this.$.toast.text = 'Failed to load action.';
        this.$.toast.show();
      },

      _onFindPrereqs: function(ros, actionId) {
        if (ros && actionId) {
          var msg = {
            collection: {
              db: 'pr2_pbd',
              collection: 'actions',
            },
            id: actionId,
          };
          this.$.findService.call(msg);
        }
      },

      _onNameChange: function() {
        this.action.name = this.$.nameInput.value;
        var msg = {
          collection: {
            db: 'pr2_pbd',
            collection: 'actions',
          },
          message: {
            id: this.actionId,
            json: JSON.stringify(this.action),
            msg_type: 'pr2_pbd_interaction/Action',
          }
        };
        this.$.updateService.call(msg);
      },

      _onStartStateError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to get action steps.';
        this.$.toast.show();
      },

      _onResponse: function(evt) {
        if (evt.detail.matched_count !== 1) {
          this._onFindError();
        }
        this.action = JSON.parse(evt.detail.message.json);
      },

      _onRosChanged: function() {
        this._selectedStepChanged();
      },

      _onUpdateError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to save action to the database.';
        this.$.toast.show();
      },

      _onStopStateError: function(evt) {
        console.error(evt.detail);
        this.$.toast.text = 'Failed to unsubscribe client from robot state.';
        this.$.toast.show();
      },

      _updateState: function(clientId, actionId, selectedStep) {
        if (clientId && actionId && (selectedStep === 0 || selectedStep)) {
          this.$.startStateService.call({
            client_id: this.clientId,
            action_id: this.actionId,
            step_num: this.selectedStep,
          });
          this._update();
        }
      },

      _update: function() {
        var config = {
          globalOptions: {
            fixedFrame: '/pr2_pbd/' + this.clientId + '/base_link',
          },
          displays: [
            {
              isShown: true,
              name: 'Grid',
              type: 'grid',
              options: {
                cellSize: 1,
                color: '#cccccc',
                numCells: 20,
              },
            }, {
              isShown: true,
              name: 'Robot model',
              type: 'urdf',
              options: {
                param: 'robot_description',
                tfPrefix: '/pr2_pbd/' + this.clientId,
              },
            },
          ],
          sidebarOpened: false,
        };
        if (this.$.rviz) {
          this.$.rviz.loadConfig(config);
        } else {
          console.log('rviz not ready');
        }
      },
    });
  })();
  </script>
</dom-module>
